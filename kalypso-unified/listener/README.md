# kalypso-listener

## Superivsord setup 
```
#listener
[program:listener]
command=/app/kalypso-listener
autorestart=true
autostart=false
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stdout
stderr_logfile_maxbytes=0
```

### Steps to start the listener inside enclave 

1. Register the generator
   ```
   yarn test ./test/generatorOperations/1_register.ts
   ```

2. Stake tokens
   ```
   yarn test ./test/generatorOperations/2_stake.ts
   ```

3. Join a marketplace
   ```
   yarn test ./test/generatorOperations/3_join_market_place.ts
   ```

4. Update the ECIES key with the help of KalypsoSDK
    ```
   yarn test ./test/generatorOperations/4_update_ecies_key.ts
    ```
5. Generate the config setup by making an HTTP call to the generator client:
    ```
   curl --location --request POST 'http://43.205.85.160:5000/api/generatorConfigSetup' \
   --header 'Content-Type: application/json' \
   --data-raw '{
       "generator_config": [
       {
         "address": "0x0469866e13cd7DF08f5482FBb127a72fF197365D",
         "data": "Some data",
         "supported_markets": [
           "1"
         ]
       }
     ],
   
     "runtime_config": {
       "ws_url": "wss://arb-sepolia.g.alchemy.com/v2/********************",
       "http_url": "https://arb-sepolia.g.alchemy.com/v2/*******************",
       "start_block":29108940,
       "private_key": "******************************",
       "chain_id": 421614,
       "payment_token": "0x01d84D33CC8636F83d2bb771e184cE57d8356863",
       "staking_token": "0xdb69299dDE4A00c99b885D9f8748B2AeD1Fe4Ed4",
       "attestation_verifier": "0x3aB3487269206d5f6a10725d4e477BaA3611adcA",
       "entity_registry": "0xBf6AfC0dB112e1e330Ea3fF4640Bac5fBA3e4B65",
       "proof_market_place": "0x81C80965f4E1b073858cc9D55d7D9A517C9fF258",
       "generator_registry": "0x2CcCb1ac0fa40922bc800619E09fc3bD821ea4F8",
       "markets":{
           "1":{
               "port":"6000",
               "ivs_url":"****************"
           }
       }
     }
   
   }'
    ```

6. Start the kalypso-listener by invoking the following API call
    ```
    curl --location --request POST 'http://43.205.85.160:5000/api/startProgram' \
    --header 'Content-Type: application/json' \
    --data-raw '{
        "program_name":"listener"
    }'
    ```

## Sample listener logs 

```
[2024-04-01T08:24:14Z INFO  kalypso_listener] Need to generate proof for ASK ID : 299
[2024-04-01T08:24:15Z INFO  kalypso_listener::listener] Finding the logs from block 29108940, for ask: 299
[2024-04-01T08:24:15Z INFO  kalypso_listener::listener] Logs found: 1
[2024-04-01T08:24:15Z INFO  kalypso_listener::listener] Secret input found
[2024-04-01T08:24:15Z INFO  kalypso_listener::listener] Took 320 ms for fetching the secret inputs for the ask
[2024-04-01T08:24:15Z INFO  kalypso_listener::listener] Forwarding inputs for market ID : "1" to the generator running on port "6000"
[2024-04-01T08:24:15Z INFO  kalypso_listener::listener] endpoint : http://0.0.0.0:6000/api/generateProof
[2024-04-01T08:24:15Z INFO  zkbob_generator::handler] Request received by the zkb generator for ask ID : 299
[2024-04-01T08:24:15Z INFO  zkbob_generator::zkbob_generator] Proof generation started...
[2024-04-01T08:24:23Z INFO  zkbob_generator::zkbob_generator] Proof generation time: 7.743977236s
[2024-04-01T08:24:23Z INFO  zkbob_generator::zkbob_generator] Proof verification status : true
[2024-04-01T08:24:23Z INFO  zkbob_generator::zkbob_generator] proof: Some(Bytes(0x1a07806aa272b3c84f6a9359bbd828d57d627b06e717cf16a39c7c88dcb7a1e61123256563c378a36cc575f577167a3fb3e1a4b3523f0a152e937def06e6b6022f3ee0795575dc147d1539f4df1bfc759a035ce2a9a49763ebcaecb723fd823e2654befc4370d4bfe8ad6ab7662a1634c6c33713ec8bbd08517c3b3d51c5171114e1ecfbd100563a769dc0b7bce0f3b7f36dd89032759adf8ce677cbc7a12c191ce3b340274f98686733c0bde0f784a16d196eadd712b43893dfa16a9b369f37080d890b93823991c6ee0c72aed037e34bfdae505bfd90c42d29a2c16165787622bfd74de09b26d42e9a5f556472855c562717d7e437e73200a07fefe6880692))
[2024-04-01T08:24:23Z INFO  zkbob_generator::handler] Proof generated by the zkb generator for ask ID : 299
[2024-04-01T08:24:23Z INFO  kalypso_listener::listener] "Proof generated"
[2024-04-01T08:24:23Z INFO  kalypso_listener] Submitting proof on-chain...
[2024-04-01T08:24:26Z INFO  kalypso_listener] Submitted proof for New ask with id : 299 via transaction 0x737cee6de9dcee7383af943a3e004e79ca8ceda4f3c31a869ebffa4139265fd2
```
